{{ config(materialized="table", database="RBOK_RPT", schema="ECOM_ANALYTICS") }}

(Select
EVENT_DATE,
USER_SESSION_KEY,
MAX_CHECKOUT_STAGE,
ECOMMERCE_TRANSACTION_ID,
DEVICE_CATEGORY,
sum(UNITS_ORDERED) as UNITS_ORDERED,
ITEMS_ITEM_ID as ARTICLE,
upper(STYLE) as STYLE,
FRANCHISE,
GENDER,
CORPORATE_MARKETING_LINE,
PRODUCT_TYPE,
CATEGORY_MARKETING_LINE,
sum(ITEMS_ITEM_REVENUE_IN_USD) as ITEMS_ITEM_REVENUE_IN_USD,
LASTTOUCH_TRAFFIC_CAMPAIGN,
LASTTOUCH_TRAFFIC_MEDIUM,
LASTTOUCH_TRAFFIC_SOURCE,
DIVISION_NAME,
KEY_CATEGORY_DESC,
BUSINESS_SEGMENT_DESC,
CALDT,
ACCTGPRDQTRNUM,
ACCTGPRDQTRLNGNM,
ACCTGPRDYRNM,
ACCTGPRDYR,
ACCTGPRDQTRNM,
ACCTGPRDMNTHNM,
ACCTGPRDWOYNM,
ACCTGPRDWOYNM_NUMBER,
SEASNNM,
ACCTGPRDYRWKNUM,
ACCTGPRDMNTHNUM
from "SPARC_BASE"."ECOM_ANALYTICS"."GA4_SNAPSHOT_V6"
WHERE EVENT_NAME_ORIGINAL='purchase'
GROUP BY
EVENT_DATE,
USER_SESSION_KEY,
MAX_CHECKOUT_STAGE,
ECOMMERCE_TRANSACTION_ID,
DEVICE_CATEGORY,
ARTICLE,
STYLE,
FRANCHISE,
GENDER,
CORPORATE_MARKETING_LINE,
PRODUCT_TYPE,
CATEGORY_MARKETING_LINE,
LASTTOUCH_TRAFFIC_CAMPAIGN,
LASTTOUCH_TRAFFIC_MEDIUM,
LASTTOUCH_TRAFFIC_SOURCE,
DIVISION_NAME,
KEY_CATEGORY_DESC,
BUSINESS_SEGMENT_DESC,
CALDT,
ACCTGPRDQTRNUM,
ACCTGPRDQTRLNGNM,
ACCTGPRDYRNM,
ACCTGPRDYR,
ACCTGPRDQTRNM,
ACCTGPRDMNTHNM,
ACCTGPRDWOYNM,
ACCTGPRDWOYNM_NUMBER,
SEASNNM,
ACCTGPRDYRWKNUM,
ACCTGPRDMNTHNUM
ORDER BY EVENT_DATE, USER_SESSION_KEY DESC
)

UNION

(
Select
EVENT_DATE,
USER_SESSION_KEY,
MAX_CHECKOUT_STAGE,
ECOMMERCE_TRANSACTION_ID,
DEVICE_CATEGORY,
sum(UNITS_ORDERED) as UNITS_ORDERED,
ARTICLE,
upper(STYLE) as STYLE,
FRANCHISE,
GENDER,
CORPORATE_MARKETING_LINE,
PRODUCT_TYPE,
CATEGORY_MARKETING_LINE,
sum(ITEMS_ITEM_REVENUE_IN_USD) as ITEMS_ITEM_REVENUE_IN_USD,
LASTTOUCH_TRAFFIC_CAMPAIGN,
LASTTOUCH_TRAFFIC_MEDIUM,
LASTTOUCH_TRAFFIC_SOURCE,
DIVISION_NAME,
KEY_CATEGORY_DESC,
BUSINESS_SEGMENT_DESC,
CALDT,
ACCTGPRDQTRNUM,
ACCTGPRDQTRLNGNM,
ACCTGPRDYRNM,
ACCTGPRDYR,
ACCTGPRDQTRNM,
ACCTGPRDMNTHNM,
ACCTGPRDWOYNM,
ACCTGPRDWOYNM_NUMBER,
SEASNNM,
ACCTGPRDYRWKNUM,
ACCTGPRDMNTHNUM
from(
Select
EVENT_DATE,
USER_SESSION_KEY,
MAX_CHECKOUT_STAGE,
NULL as ECOMMERCE_TRANSACTION_ID,
DEVICE_CATEGORY,
NULL as UNITS_ORDERED,
NULL as ARTICLE,
NULL as STYLE,
NULL as FRANCHISE,
NULL as GENDER,
NULL as CORPORATE_MARKETING_LINE,
NULL as PRODUCT_TYPE,
NULL as CATEGORY_MARKETING_LINE,
NULL as ITEMS_ITEM_REVENUE_IN_USD,
LASTTOUCH_TRAFFIC_CAMPAIGN,
LASTTOUCH_TRAFFIC_MEDIUM,
LASTTOUCH_TRAFFIC_SOURCE,
NULL as DIVISION_NAME,
NULL as KEY_CATEGORY_DESC,
NULL as BUSINESS_SEGMENT_DESC,
CALDT,
ACCTGPRDQTRNUM,
ACCTGPRDQTRLNGNM,
ACCTGPRDYRNM,
ACCTGPRDYR,
ACCTGPRDQTRNM,
ACCTGPRDMNTHNM,
ACCTGPRDWOYNM,
ACCTGPRDWOYNM_NUMBER,
SEASNNM,
ACCTGPRDYRWKNUM,
ACCTGPRDMNTHNUM
from "SPARC_BASE"."ECOM_ANALYTICS"."GA4_SNAPSHOT_V6"
WHERE USER_SESSION_KEY NOT IN
(
SELECT distinct USER_SESSION_KEY from "SPARC_BASE"."ECOM_ANALYTICS"."GA4_SNAPSHOT_V6"
WHERE EVENT_NAME_ORIGINAL='purchase'
)
)
GROUP BY
EVENT_DATE,
USER_SESSION_KEY,
MAX_CHECKOUT_STAGE,
ECOMMERCE_TRANSACTION_ID,
DEVICE_CATEGORY,
ARTICLE,
STYLE,
FRANCHISE,
GENDER,
CORPORATE_MARKETING_LINE,
PRODUCT_TYPE,
CATEGORY_MARKETING_LINE,
LASTTOUCH_TRAFFIC_CAMPAIGN,
LASTTOUCH_TRAFFIC_MEDIUM,
LASTTOUCH_TRAFFIC_SOURCE,
DIVISION_NAME,
KEY_CATEGORY_DESC,
BUSINESS_SEGMENT_DESC,
CALDT,
ACCTGPRDQTRNUM,
ACCTGPRDQTRLNGNM,
ACCTGPRDYRNM,
ACCTGPRDYR,
ACCTGPRDQTRNM,
ACCTGPRDMNTHNM,
ACCTGPRDWOYNM,
ACCTGPRDWOYNM_NUMBER,
SEASNNM,
ACCTGPRDYRWKNUM,
ACCTGPRDMNTHNUM
ORDER BY EVENT_DATE, USER_SESSION_KEY DESC
)
