{{ config(materialized="table", database="RBOK_RPT", schema="ECOM_ANALYTICS") }}

Select 
//LOCATION_PK,
TRANSACTION_DATE,
--Sales.ITEM_PK,
sum(UNITS_SOLD) as UNITS_SOLD,
sum(GROSS_SALES_USD) as GROSS_SALES_USD,
sum(COST_USD) as COST_USD,
(sum(GROSS_SALES_USD)-sum(COST_USD)) as MARGIN_SALES,
(CASE WHEN DISCOUNT_USD>0 THEN 1 ELSE 0 END) as DISCOUNTED_FLAG,
sum(PROMO_MARKDOWN_USD) as PROMO_MARKDOWN_USD,
sum(TOTAL_MARKDOWNS_USD) as TOTAL_MARKDOWNS_USD,
sum(DISCOUNT_USD) as DISCOUNT_USD,
//count(distinct ORIGINAL_TRANSACTION_ID) as NUMBER_OF_ORDERS,
//DISCOUNT_REASON_CODE,
//PROMOTION_ID,
TRANSACTION_TYPE_CODE,
ITEM_SEASON_NAME,
--ARTICLE,
PRODUCT_GROUP,
ARTICLE_CREATION_SEASON,
ARTICLE_ACTIVE_SEASON,
DIVISION_NAME,
STYLE_NAME,
--Product.MODEL_NUMBER,
VENDOR_ID,
FORECAST_IND,
ORIGINAL_RETAIL,
BUSINESS_SEGMENT,
KEY_CATEGORY,
SPARC_LOCATION_ID,
BRAND_LOCATION_ID,
LOCATION_NAME,
SUB_CHANNEL_ID,
SUB_CHANNEL,
CHANNEL_ID,
CHANNEL,
CITY,
STATE,
POSTAL_CODE,
COUNTRY,
LATITUDE,
LONGITUDE
from
(
Select --TOP 1000000
//Sales.LOCATION_PK,
Sales.TRANSACTION_DATE,
--Sales.ITEM_PK,
Sales.UNITS_SOLD,
Sales.GROSS_SALES_USD,
//Sales.DISCOUNT_REASON_CODE,
//Sales.PROMOTION_ID,
Sales.TRANSACTION_TYPE_CODE,
Sales.PROMO_MARKDOWN_USD,
Sales.TOTAL_MARKDOWNS_USD,
Sales.COST_USD,
Sales.DISCOUNT_USD,
//Sales.ORIGINAL_TRANSACTION_ID,
--Product.ARTICLE,
Product.ITEM_SEASON_NAME,
Product.PRODUCT_GROUP,
Product.ARTICLE_CREATION_SEASON,
Product.ARTICLE_ACTIVE_SEASON,
Product.DIVISION_NAME,
Product.STYLE_NAME,
Product.MODEL_NUMBER,
Product.VENDOR_ID,
Product.FORECAST_IND,
Product.ORIGINAL_RETAIL,
Product.BUSINESS_SEGMENT,
Product.KEY_CATEGORY,
//Location.LOCATION_PK,
Location.SPARC_LOCATION_ID,
Location.BRAND_LOCATION_ID,
Location.LOCATION_NAME,
Location.SUB_CHANNEL_ID,
Location.SUB_CHANNEL,
Location.CHANNEL_ID,
Location.CHANNEL,
//Location.OPEN_DATE,
//Location.CLOSE_DATE,
Location.CITY,
Location.STATE,
Location.POSTAL_CODE,
Location.COUNTRY,
Location.LATITUDE,
Location.LONGITUDE
FROM "SPARC_BASE"."ECOM_ANALYTICS"."FACT_RETAIL_SALES" as Sales
LEFT JOIN "SPARC_BASE"."ECOM_ANALYTICS"."DIM_PRODUCT" as Product on Product.ITEM_PK=Sales.ITEM_PK
LEFT JOIN "SPARC_BASE"."ECOM_ANALYTICS"."DIM_LOCATION" as Location on Location.LOCATION_PK=Sales.LOCATION_PK
//  WHERE Sales.DISCOUNT_USD>0
//WHERE Location.LOCATION_PK IN ('ad9062fbdc574edde46728355328d073')
)
GROUP BY
//LOCATION_PK,
TRANSACTION_DATE,
//COST_USD,
//DISCOUNT_REASON_CODE,
//PROMOTION_ID,
TRANSACTION_TYPE_CODE,
--ARTICLE,
ITEM_SEASON_NAME,
PRODUCT_GROUP,
ARTICLE_CREATION_SEASON,
ARTICLE_ACTIVE_SEASON,
DIVISION_NAME,
STYLE_NAME,
--Product.MODEL_NUMBER,
VENDOR_ID,
FORECAST_IND,
ORIGINAL_RETAIL,
BUSINESS_SEGMENT,
KEY_CATEGORY,
DISCOUNTED_FLAG,
SPARC_LOCATION_ID,
BRAND_LOCATION_ID,
LOCATION_NAME,
SUB_CHANNEL_ID,
SUB_CHANNEL,
CHANNEL_ID,
CHANNEL,
CITY,
STATE,
POSTAL_CODE,
COUNTRY,
LATITUDE,
LONGITUDE